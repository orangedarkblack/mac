name: macOS AnyDesk Force
on: workflow_dispatch

jobs:
  anydesk-session:
    runs-on: macos-latest
    steps:
      - name: Preparar Entorno y AnyDesk
        run: |
          # 1. Arreglar permisos de Homebrew
          sudo chown -R $(whoami) /opt/homebrew
          
          # 2. Instalar AnyDesk
          brew install --cask anydesk

      - name: Forzar Inicio de Servicio y Pantalla
        run: |
          # Forzar que el sistema gráfico despierte (ignora el error de resolución)
          sudo /usr/bin/login -f runner || true
          
          # Iniciar AnyDesk en segundo plano con permisos de sistema
          sudo /Applications/AnyDesk.app/Contents/MacOS/AnyDesk --service &
          sleep 10
          
          # Configurar contraseña de acceso desatendido
          echo "Clave123" | sudo /Applications/AnyDesk.app/Contents/MacOS/AnyDesk --set-password
          
          # Intentar obtener el ID (repetir si es necesario)
          echo "------------------------------------------"
          echo "ESPERANDO ID DE ANYDESK..."
          for i in {1..5}; do
            ANYDESK_ID=$(sudo /Applications/AnyDesk.app/Contents/MacOS/AnyDesk --get-id)
            if [ ! -z "$ANYDESK_ID" ]; then
              echo "TU ID DE ANYDESK ES: $ANYDESK_ID"
              break
            fi
            sleep 5
          done
          echo "CONTRASEÑA: Clave123"
          echo "------------------------------------------"

      - name: Mantener vivo
        run: sleep 21600
